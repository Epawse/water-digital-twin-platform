# Proposal: Add GIS Drawing Toolkit

## Summary
**ç»Ÿä¸€é‡æ„**æµ‹é‡å’Œç»˜åˆ¶å·¥å…·ï¼Œæ„å»ºå®Œæ•´çš„ 3D GIS å·¥å…·é›†ï¼Œæ•´åˆ Cesium 3D æ¸²æŸ“èƒ½åŠ›å’Œæˆç†Ÿçš„ 2D GIS äº¤äº’æ¨¡å¼ï¼Œä¸ºæ°´åˆ©æ•°å­—å­ªç”Ÿå¹³å°æä¾›ä¸“ä¸šçº§çš„åœ°å›¾æ ‡æ³¨ã€è§„åˆ’ä¸æ•°æ®é‡‡é›†åŠŸèƒ½ã€‚

**æ­¤å˜æ›´å–ä»£ï¼ˆsupersedesï¼‰`implement-gis-measure-tools`**ï¼šç°æœ‰çš„MeasureLayer.vueå°†è¢«ç»Ÿä¸€çš„GISLayer.vueæ›¿ä»£ï¼Œæµ‹é‡åŠŸèƒ½ä½œä¸ºMeasureToolç±»é‡æ–°å®ç°ï¼Œæ¶æ„æ›´æ¸…æ™°ã€åŠŸèƒ½æ›´å¼ºå¤§ã€‚

## Motivation

### ä¸šåŠ¡éœ€æ±‚
1. **åœºæ™¯æ ‡æ³¨**ï¼šåœ¨ 3D æ°´åˆ©åœºæ™¯ä¸­æ ‡æ³¨å…³é”®ä½ç½®ï¼ˆç›‘æµ‹ç‚¹ã€æ°´åº“ã€å ¤åã€æ³µç«™ç­‰ï¼‰
2. **è§„åˆ’è¾…åŠ©**ï¼šç»˜åˆ¶æ´ªæ°´é¢„è­¦åŒºåŸŸã€ç–æ•£è·¯å¾„ã€ä¿æŠ¤åŒºè¾¹ç•Œ
3. **æ•°æ®é‡‡é›†**ï¼šç°åœºå‹˜æµ‹ã€ç¾å®³è®°å½•ã€å·¥ç¨‹æµ‹é‡
4. **å†³ç­–æ”¯æŒ**ï¼šå¿«é€Ÿç»˜åˆ¶åˆ†æåŒºåŸŸã€å¯¹æ¯”ä¸åŒæ–¹æ¡ˆ

### æŠ€æœ¯ç°çŠ¶
- âš ï¸ **ç°æœ‰æµ‹é‡å·¥å…·å­˜åœ¨é—®é¢˜**ï¼š
  - MeasureLayer.vueä¸º634è¡Œå•ä½“ç»„ä»¶ï¼Œéš¾ä»¥æ‰©å±•
  - æ— ç¼–è¾‘èƒ½åŠ›ï¼ˆç»˜åˆ¶åæ— æ³•ä¿®æ”¹ï¼‰
  - æ— æ ·å¼é…ç½®
  - æ— 3Dé«˜ç¨‹æ”¯æŒ
  - æ¶æ„ä¸ç»˜åˆ¶å·¥å…·é‡å¤
- âš ï¸ **ç¼ºå¤±åŠŸèƒ½**ï¼šç‚¹æ ‡æ³¨ã€çº¿ç»˜åˆ¶ã€åœ†å½¢/çŸ©å½¢å·¥å…·ã€è¦ç´ ç¼–è¾‘ã€æ ·å¼é…ç½®ã€æ•°æ®å¯¼å…¥å¯¼å‡º
- ğŸ“š **å‚è€ƒèµ„æº**ï¼šæˆç†Ÿçš„ 2D OpenLayers GIS é¡¹ç›®å®è·µ + cesium-drawerç­‰å¼€æºåº“

### æ ¸å¿ƒä»·å€¼
- **å®Œæ•´æ€§**ï¼šä»æµ‹é‡å·¥å…·å‡çº§ä¸ºå®Œæ•´çš„ GIS å·¥ä½œå°
- **ä¸“ä¸šæ€§**ï¼šå‚è€ƒ GIS è¡Œä¸šæ ‡å‡†äº¤äº’æ¨¡å¼ï¼ˆDrawã€Selectã€Modifyã€Snapï¼‰
- **å¤ç”¨æ€§**ï¼š70% ä»£ç å¯åŸºäºç°æœ‰ MeasureLayer æ‰©å±•
- **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

## Scope

### IN - æ ¸å¿ƒåŠŸèƒ½

#### Phase 1: åŸºç¡€ç»˜åˆ¶å·¥å…·
- **ç‚¹æ ‡æ³¨å·¥å…·**
  - å•å‡»åœ°å›¾æ·»åŠ ç‚¹æ ‡è®°
  - æ”¯æŒè‡ªå®šä¹‰å›¾æ ‡ï¼ˆé»˜è®¤/è‡ªå®šä¹‰å›¾ç‰‡ï¼‰
  - æ”¯æŒæ–‡æœ¬æ ‡æ³¨ï¼ˆåç§°ã€æè¿°ï¼‰
  - é¢œè‰²é…ç½®ï¼ˆç‚¹é¢œè‰²ã€è¾¹æ¡†é¢œè‰²ï¼‰

- **çº¿ç»˜åˆ¶å·¥å…·**
  - è¿ç»­ç‚¹å‡»ç»˜åˆ¶æŠ˜çº¿
  - å³é”®æˆ– ESC å®Œæˆç»˜åˆ¶
  - å®æ—¶æ˜¾ç¤ºçº¿æ®µé•¿åº¦
  - çº¿å‹æ”¯æŒï¼ˆå®çº¿ã€è™šçº¿ï¼‰

- **åœ†å½¢ç»˜åˆ¶å·¥å…·**
  - ç¬¬ä¸€æ¬¡ç‚¹å‡»ç¡®å®šåœ†å¿ƒ
  - é¼ æ ‡ç§»åŠ¨åŠ¨æ€è°ƒæ•´åŠå¾„
  - ç¬¬äºŒæ¬¡ç‚¹å‡»å®Œæˆ
  - æ˜¾ç¤ºåŠå¾„å’Œé¢ç§¯

- **çŸ©å½¢ç»˜åˆ¶å·¥å…·**
  - æ‹–æ‹½æ–¹å¼ç»˜åˆ¶çŸ©å½¢
  - å®æ—¶æ˜¾ç¤ºå°ºå¯¸ï¼ˆé•¿Ã—å®½ï¼‰
  - æ˜¾ç¤ºé¢ç§¯

#### Phase 2: è¦ç´ é€‰æ‹©ä¸ç®¡ç†
- **é€‰æ‹©å·¥å…·**
  - ç‚¹å‡»é€‰ä¸­å·²ç»˜åˆ¶çš„è¦ç´ 
  - é«˜äº®æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼ˆé¢œè‰²å˜åŒ–ï¼‰
  - æ˜¾ç¤ºè¦ç´ å±æ€§ï¼ˆç±»å‹ã€å°ºå¯¸ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰
  - å¤šé€‰æ”¯æŒï¼ˆCtrl+Click æˆ–æ¡†é€‰ï¼‰

- **è¦ç´ åˆ—è¡¨é¢æ¿**
  - æ˜¾ç¤ºæ‰€æœ‰ç»˜åˆ¶çš„è¦ç´ 
  - æŒ‰ç±»å‹åˆ†ç»„ï¼ˆç‚¹/çº¿/é¢ï¼‰
  - æœç´¢/è¿‡æ»¤åŠŸèƒ½
  - æ‰¹é‡æ“ä½œï¼ˆæ˜¾ç¤º/éšè—ã€åˆ é™¤ï¼‰

#### Phase 3: è¦ç´ ç¼–è¾‘
- **è¦ç´ ç§»åŠ¨**
  - æ‹–æ‹½é€‰ä¸­çš„è¦ç´ æ•´ä½“ç§»åŠ¨
  - å®æ—¶æ›´æ–°ä½ç½®
  - æ˜¾ç¤ºç§»åŠ¨è·ç¦»

- **é¡¶ç‚¹ç¼–è¾‘**
  - åŒå‡»è¦ç´ è¿›å…¥ç¼–è¾‘æ¨¡å¼
  - æ‹–æ‹½é¡¶ç‚¹ä¿®æ”¹å‡ ä½•å½¢çŠ¶
  - åˆ é™¤é¡¶ç‚¹ï¼ˆShift+Clickï¼‰
  - æ’å…¥é¡¶ç‚¹ï¼ˆç‚¹å‡»è¾¹çš„ä¸­ç‚¹ï¼‰
  - é€€å‡ºç¼–è¾‘ï¼ˆESC æˆ–ç‚¹å‡»ç©ºç™½ï¼‰

#### Phase 4: æ ·å¼é…ç½®ç³»ç»Ÿ
- **æ ·å¼é¢æ¿**
  - å¡«å……é¢œè‰²é€‰æ‹©å™¨ï¼ˆæ”¯æŒé€æ˜åº¦ï¼‰
  - è¾¹æ¡†é¢œè‰²é€‰æ‹©å™¨
  - çº¿å®½è°ƒæ•´ï¼ˆ1-10pxï¼‰
  - çº¿å‹é€‰æ‹©ï¼ˆå®çº¿ã€è™šçº¿ã€ç‚¹çº¿ï¼‰
  - å›¾æ ‡é€‰æ‹©ï¼ˆé¢„è®¾å›¾æ ‡åº“ï¼‰

- **æ ·å¼é¢„è®¾**
  - ä¿å­˜å¸¸ç”¨æ ·å¼
  - å¿«é€Ÿåº”ç”¨æ ·å¼æ¨¡æ¿
  - æ ·å¼å¤åˆ¶/ç²˜è´´

#### Phase 5: å±æ€§ä¸æ•°æ®ç®¡ç†
- **å±æ€§ç¼–è¾‘**
  - åç§°/æ ‡é¢˜
  - æè¿°/å¤‡æ³¨
  - è‡ªå®šä¹‰å­—æ®µï¼ˆæ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸï¼‰
  - é™„ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡ã€æ–‡æ¡£ï¼‰

- **æ•°æ®å¯¼å…¥å¯¼å‡º**
  - GeoJSON å¯¼å‡ºï¼ˆä¿å­˜æ‰€æœ‰ç»˜åˆ¶å†…å®¹ï¼‰
  - GeoJSON å¯¼å…¥ï¼ˆåŠ è½½å¤–éƒ¨æ•°æ®ï¼‰
  - å¯¼å‡ºé€‰é¡¹ï¼ˆä»…é€‰ä¸­é¡¹/å…¨éƒ¨ï¼‰
  - æ ¼å¼éªŒè¯ä¸é”™è¯¯æç¤º

#### Phase 6: é«˜çº§åŠŸèƒ½
- **æ•æ‰åŠŸèƒ½**
  - é¡¶ç‚¹æ•æ‰ï¼ˆè‡ªåŠ¨å¯¹é½åˆ°ç°æœ‰é¡¶ç‚¹ï¼‰
  - è¾¹æ•æ‰ï¼ˆè‡ªåŠ¨å¯¹é½åˆ°è¾¹ä¸­ç‚¹ï¼‰
  - å¯é…ç½®æ•æ‰å®¹å·®ï¼ˆ5-20pxï¼‰
  - è§†è§‰åé¦ˆï¼ˆé«˜äº®æ•æ‰ç›®æ ‡ï¼‰

- **å†å²æ“ä½œ**
  - æ’¤é”€ï¼ˆCtrl+Zï¼‰
  - é‡åšï¼ˆCtrl+Yï¼‰
  - æ“ä½œå†å²æ ˆï¼ˆæœ€å¤š50æ­¥ï¼‰

### OUT - ä¸åŒ…å«çš„åŠŸèƒ½
- åœ°å½¢å‰–é¢å·¥å…·ï¼ˆç‹¬ç«‹ proposalï¼‰
- æ·¹æ²¡åˆ†æå·¥å…·ï¼ˆç‹¬ç«‹ proposalï¼‰
- Shapefile ç›´æ¥å¯¼å…¥ï¼ˆå¯é€šè¿‡è½¬ GeoJSONï¼‰
- è‡ªç”±æ‰‹ç»˜å·¥å…·ï¼ˆæ€§èƒ½è€ƒè™‘ï¼‰
- 3D ä½“ç§¯æµ‹é‡ï¼ˆéœ€è¦é«˜ç¨‹æ•°æ®ï¼‰
- ç¦»çº¿æ¨¡å¼/æœ¬åœ°å­˜å‚¨ï¼ˆæš‚ä¸éœ€è¦ï¼‰

## Approach

### Technology Selection (Updated 2025-12-03)

After comprehensive research on Cesium GIS ecosystem, we have decided to adopt a **Hybrid Architecture (Option A)** that combines:

1. **Core Architecture**: Custom-built abstractions (BaseTool, BaseGraphic) for full control
2. **2D Algorithms**: Extract proven code from open-source MIT-licensed libraries
   - **cesium-drawer** (hongfaqiu) - Polygon editing logic â­â­â­â­â­
   - **@cesium-extends/drawer** - Point/line/circle drawing
3. **3D Algorithms**: Extract volume/flood simulation from **cesium_dev_kit** â­â­â­â­â­
4. **UI Layer**: Custom components matching project's "HUD Immersive Cockpit" style

**Key Benefits**:
- âœ… **Fast Delivery**: 2D features in 1 week (vs 2-3 weeks pure custom)
- âœ… **Battle-Tested**: Reuse algorithms from production-proven libraries
- âœ… **Full Control**: Code lives in our project, fully customizable
- âœ… **License Safe**: All sources are MIT licensed
- âœ… **3D Ready**: Architecture designed for future 3D analysis tools

**Alternatives Considered**:
- âŒ Cesium ion SDK - Requires commercial license
- âŒ Mars3D - Modifies Cesium source, creates vendor lock-in
- âŒ Pure custom - Too slow, reinventing the wheel

See `design.md` for detailed technology research and decision rationale.

### æŠ€æœ¯æ¶æ„

#### 1. ç»„ä»¶è®¾è®¡ (Updated with Hybrid Architecture)
```
src/
â”œâ”€â”€ cesium/gis/                 # æ–°å»ºï¼ˆGISæ ¸å¿ƒåº“ï¼‰
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæŠ½è±¡å±‚
â”‚   â”‚   â”œâ”€â”€ BaseTool.ts         # å·¥å…·åŸºç±»
â”‚   â”‚   â”œâ”€â”€ BaseGraphic.ts      # å›¾å½¢åŸºç±»
â”‚   â”‚   â”œâ”€â”€ ToolManager.ts      # å·¥å…·ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ StyleManager.ts     # æ ·å¼ç®¡ç†
â”‚   â”œâ”€â”€ graphics/               # å›¾å½¢ç±»
â”‚   â”‚   â”œâ”€â”€ PointGraphic.ts
â”‚   â”‚   â”œâ”€â”€ LineGraphic.ts
â”‚   â”‚   â”œâ”€â”€ PolygonGraphic.ts   # â† uses cesium-drawer algorithm
â”‚   â”‚   â”œâ”€â”€ CircleGraphic.ts
â”‚   â”‚   â””â”€â”€ RectangleGraphic.ts
â”‚   â”œâ”€â”€ tools/                  # å·¥å…·ç±»
â”‚   â”‚   â”œâ”€â”€ DrawTool.ts
â”‚   â”‚   â”œâ”€â”€ SelectTool.ts
â”‚   â”‚   â”œâ”€â”€ ModifyTool.ts
â”‚   â”‚   â”œâ”€â”€ MeasureTool.ts
â”‚   â”‚   â””â”€â”€ SnapHelper.ts
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ coordinate.ts
â”‚   â”‚   â”œâ”€â”€ geometry.ts
â”‚   â”‚   â”œâ”€â”€ volume.ts           # â† from cesium_dev_kit
â”‚   â”‚   â””â”€â”€ spatial-index.ts
â”‚   â””â”€â”€ vendor/                 # æå–çš„å¼€æºä»£ç 
â”‚       â”œâ”€â”€ cesium-drawer/      # MIT License
â”‚       â””â”€â”€ cesium-extends/     # MIT License
â”œâ”€â”€ components/cesium/
â”‚   â”œâ”€â”€ GISLayer.vue            # ç»Ÿä¸€å›¾å±‚ï¼ˆæ›¿ä»£MeasureLayerï¼‰
â”‚   â””â”€â”€ HeightModePanel.vue     # 3Dé«˜åº¦æ¨¡å¼
â”œâ”€â”€ components/common/
â”‚   â”œâ”€â”€ DrawToolbar.vue         # ç»˜åˆ¶å·¥å…·æ 
â”‚   â”œâ”€â”€ FeatureListPanel.vue    # è¦ç´ åˆ—è¡¨
â”‚   â”œâ”€â”€ StylePanel.vue          # æ ·å¼é…ç½®
â”‚   â””â”€â”€ PropertiesPanel.vue     # å±æ€§ç¼–è¾‘
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ gis.ts                  # ç»Ÿä¸€Storeï¼ˆæ›¿ä»£measure.tsï¼‰
â””â”€â”€ types/
    â”œâ”€â”€ geometry.ts             # Coordinate3D, HeightReference
    â”œâ”€â”€ draw.ts
    â””â”€â”€ feature.ts
```

#### 2. äº¤äº’æµç¨‹

**ç»˜åˆ¶æµç¨‹ï¼ˆä»¥åœ†å½¢ä¸ºä¾‹ï¼‰ï¼š**
```
1. ç”¨æˆ·ç‚¹å‡»å·¥å…·æ "åœ†å½¢"æŒ‰é’®
2. drawStore.setTool('circle')
3. DrawLayer ç›‘å¬åˆ°å·¥å…·æ¿€æ´»
4. ç”¨æˆ·ç‚¹å‡»åœ°å›¾è®¾ç½®åœ†å¿ƒ â†’ æ·»åŠ åœ†å¿ƒæ ‡è®°
5. é¼ æ ‡ç§»åŠ¨ â†’ é¢„è§ˆåœ†å½¢ï¼ˆåŠ¨æ€åŠå¾„ï¼‰
6. ç”¨æˆ·å†æ¬¡ç‚¹å‡» â†’ å®Œæˆç»˜åˆ¶
7. åˆ›å»º CircleFeature å®ä½“
8. æ·»åŠ åˆ° featureStore.features[]
9. æ˜¾ç¤ºåœ¨ FeatureListPanel
```

**ç¼–è¾‘æµç¨‹ï¼š**
```
1. ç”¨æˆ·ç‚¹å‡»è¦ç´ é€‰ä¸­
2. featureStore.selectFeature(id)
3. é«˜äº®æ˜¾ç¤ºï¼ˆé¢œè‰²å˜åŒ–ï¼‰
4. æ˜¾ç¤º PropertiesPanelï¼ˆå±æ€§ï¼‰
5. ç”¨æˆ·åŒå‡»è¦ç´ è¿›å…¥ç¼–è¾‘æ¨¡å¼
6. EditLayer æ˜¾ç¤ºå¯ç¼–è¾‘é¡¶ç‚¹
7. ç”¨æˆ·æ‹–æ‹½é¡¶ç‚¹
8. ä½¿ç”¨ CallbackProperty å®æ—¶æ›´æ–°å‡ ä½•
9. ESC é€€å‡ºç¼–è¾‘æ¨¡å¼
10. æ›´æ–° featureStore
```

#### 3. æ•°æ®æ¨¡å‹

**Feature ç±»å‹å®šä¹‰ï¼š**
```typescript
interface BaseFeature {
  id: string
  type: 'point' | 'line' | 'polygon' | 'circle' | 'rectangle' | 'distance' | 'area'
  name: string
  description?: string
  createdAt: Date
  updatedAt: Date
  style: FeatureStyle
  properties: Record<string, any>
}

interface PointFeature extends BaseFeature {
  type: 'point'
  position: Coordinate
  icon?: string
  label?: string
}

interface LineFeature extends BaseFeature {
  type: 'line'
  vertices: Coordinate[]
  length: number  // ç±³
  lineType: 'solid' | 'dashed' | 'dotted'
}

interface CircleFeature extends BaseFeature {
  type: 'circle'
  center: Coordinate
  radius: number  // ç±³
  area: number    // å¹³æ–¹ç±³
}

interface FeatureStyle {
  fillColor: string       // rgba(255, 255, 255, 0.5)
  strokeColor: string     // #ffcc33
  strokeWidth: number     // 1-10
  pointSize: number       // 5-20
  opacity: number         // 0-1
}
```

#### 4. çŠ¶æ€ç®¡ç†

**DrawStoreï¼š**
```typescript
export const useDrawStore = defineStore('draw', () => {
  const activeTool = ref<DrawToolType>(null)
  const isEditing = ref(false)
  const snapEnabled = ref(true)
  const snapTolerance = ref(10)  // åƒç´ 

  function setTool(tool: DrawToolType) { ... }
  function enterEditMode(featureId: string) { ... }
  function exitEditMode() { ... }

  return {
    activeTool,
    isEditing,
    snapEnabled,
    setTool,
    enterEditMode,
    exitEditMode
  }
})
```

**FeatureStoreï¼š**
```typescript
export const useFeatureStore = defineStore('feature', () => {
  const features = ref<Feature[]>([])
  const selectedFeatureIds = ref<Set<string>>(new Set())
  const history = ref<HistoryEntry[]>([])  // æ’¤é”€/é‡åš

  function addFeature(feature: Feature) { ... }
  function updateFeature(id: string, updates: Partial<Feature>) { ... }
  function deleteFeature(id: string) { ... }
  function selectFeature(id: string, multi = false) { ... }
  function exportGeoJSON(): string { ... }
  function importGeoJSON(json: string) { ... }

  return {
    features,
    selectedFeatureIds,
    addFeature,
    updateFeature,
    deleteFeature,
    selectFeature,
    exportGeoJSON,
    importGeoJSON
  }
})
```

### UI/UX è®¾è®¡

#### å·¥å…·æ å¸ƒå±€ï¼ˆæ‰©å±• TopRibbonï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµ‹é‡å·¥å…·                      ç»˜åˆ¶å·¥å…·                   æ“ä½œ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ“è·ç¦»] [â–­é¢ç§¯]  â”‚  [ğŸ¯é€‰æ‹©] [ğŸ“ç‚¹] [ğŸ“çº¿] [â–­å¤šè¾¹å½¢] [â­•åœ†] [â–¢çŸ©å½¢]  â”‚
â”‚                   â”‚  [âœ‚ï¸ç¼–è¾‘] [ğŸ¨æ ·å¼] [ğŸ“‹å±æ€§] [ğŸ“¤å¯¼å‡º] [ğŸ“¥å¯¼å…¥]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¾§è¾¹æ é¢æ¿ï¼ˆæ–°å¢ï¼‰
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“‹ è¦ç´ åˆ—è¡¨                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ” æœç´¢: [_________]         â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  ğŸ“ ç‚¹æ ‡æ³¨ (3)                â•‘
â•‘    â”œâ”€ ç›‘æµ‹ç«™A  [ğŸ‘] [âœ] [ğŸ—‘]  â•‘
â•‘    â”œâ”€ æ°´åº“B    [ğŸ‘] [âœ] [ğŸ—‘]  â•‘
â•‘    â””â”€ æ³µç«™C    [ğŸ‘] [âœ] [ğŸ—‘]  â•‘
â•‘                               â•‘
â•‘  ğŸ“ çº¿è·¯å¾„ (2)                â•‘
â•‘    â”œâ”€ ç–æ•£è·¯çº¿1 [ğŸ‘] [âœ] [ğŸ—‘] â•‘
â•‘    â””â”€ ç®¡é“A    [ğŸ‘] [âœ] [ğŸ—‘]  â•‘
â•‘                               â•‘
â•‘  â–­ åŒºåŸŸ (4)                  â•‘
â•‘    â”œâ”€ é¢„è­¦åŒºA  [ğŸ‘] [âœ] [ğŸ—‘]  â•‘
â•‘    â””â”€ ...                    â•‘
â•‘                               â•‘
â•‘  [å…¨é€‰] [åé€‰] [æ¸…ç©º]         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¨ æ ·å¼é…ç½®                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  å¡«å……é¢œè‰²  [ğŸ¨] #FFCC33       â•‘
â•‘  é€æ˜åº¦    â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘ 50%    â•‘
â•‘                               â•‘
â•‘  è¾¹æ¡†é¢œè‰²  [ğŸ¨] #000000       â•‘
â•‘  çº¿å®½      â”â”â”â—â”â”â”â”â” 3px     â•‘
â•‘  çº¿å‹      [å®çº¿ â–¼]           â•‘
â•‘                               â•‘
â•‘  [ä¿å­˜æ ·å¼] [é‡ç½®]            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“‹ å±æ€§ç¼–è¾‘                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  åç§°      [ç›‘æµ‹ç«™A_____]     â•‘
â•‘  ç±»å‹      ç‚¹æ ‡æ³¨             â•‘
â•‘  åˆ›å»ºæ—¶é—´  2025-12-03 14:30  â•‘
â•‘                               â•‘
â•‘  è‡ªå®šä¹‰å±æ€§                   â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  è®¾å¤‡ç¼–å·  [STA001______]    â•‘
â•‘  è´Ÿè´£äºº    [å¼ ä¸‰________]    â•‘
â•‘  å¤‡æ³¨      [____________]    â•‘
â•‘            [____________]    â•‘
â•‘                               â•‘
â•‘  [ä¿å­˜] [å–æ¶ˆ]                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **å®ä½“ç®¡ç†**
   - ä½¿ç”¨ Map<featureId, Entity[]> æ˜ å°„ï¼ˆå·²åœ¨æµ‹é‡å·¥å…·ä¸­éªŒè¯ï¼‰
   - æ‰¹é‡åˆ é™¤/æ›´æ–°
   - å»¶è¿Ÿæ¸²æŸ“ï¼ˆè¶…è¿‡100ä¸ªè¦ç´ æ—¶è™šæ‹ŸåŒ–ï¼‰

2. **äº‹ä»¶å¤„ç†**
   - é¼ æ ‡ç§»åŠ¨èŠ‚æµï¼ˆ16ms / 60fpsï¼‰
   - ä½¿ç”¨ CallbackProperty åŠ¨æ€æ›´æ–°ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºï¼‰
   - äº‹ä»¶å§”æ‰˜ï¼ˆå•ä¸ª handler å¤„ç†æ‰€æœ‰è¦ç´ ï¼‰

3. **æ•°æ®ç»“æ„**
   - ç©ºé—´ç´¢å¼•ï¼ˆR-treeï¼‰ç”¨äºæ•æ‰åŠŸèƒ½
   - å››å‰æ ‘ä¼˜åŒ–é€‰æ‹©æ€§èƒ½
   - æ‡’åŠ è½½å±æ€§ï¼ˆä»…é€‰ä¸­æ—¶åŠ è½½è¯¦æƒ…ï¼‰

### æŠ€æœ¯å‚è€ƒï¼ˆ2D â†’ 3D æ˜ å°„ï¼‰

| OpenLayers 2D | Cesium 3D | å®ç°éš¾åº¦ |
|--------------|-----------|---------|
| Draw.Point | Entity.point | â­ ç®€å• |
| Draw.LineString | Entity.polyline | â­ ç®€å• |
| Draw.Polygon | Entity.polygon | â­ ç®€å• |
| Draw.Circle | Entity.ellipse | â­â­ ä¸­ç­‰ï¼ˆéœ€è®¡ç®—åŠå¾„ï¼‰|
| Draw.Box | Entity.rectangle | â­â­ ä¸­ç­‰ï¼ˆéœ€è½¬ç»çº¬åº¦èŒƒå›´ï¼‰|
| Select | scene.pick() | â­â­ ç®€å• |
| Modify | CallbackProperty | â­â­â­â­ å¤æ‚ï¼ˆé¡¶ç‚¹ç¼–è¾‘ï¼‰|
| Snap | è·ç¦»è®¡ç®— | â­â­â­â­ å¤æ‚ï¼ˆç©ºé—´ç´¢å¼•ï¼‰|
| Style | Material ç³»ç»Ÿ | â­â­ ç®€å• |
| GeoJSON | GeoJsonDataSource | â­â­ ç®€å• |

## Dependencies

### æŠ€æœ¯ä¾èµ–
- âœ… Cesium 1.1xxï¼ˆå·²æœ‰ï¼‰
- âœ… Piniaï¼ˆå·²æœ‰ï¼‰
- âœ… Vue 3 Composition APIï¼ˆå·²æœ‰ï¼‰
- ğŸ“¦ color-picker ç»„ä»¶ï¼ˆElement Plus æˆ–è‡ªå®šä¹‰ï¼‰
- ğŸ“¦ file-saverï¼ˆå¯¼å‡ºæ–‡ä»¶ï¼‰

### ç°æœ‰åŸºç¡€è®¾æ–½ï¼ˆå¯å¤ç”¨ï¼‰
- âœ… MeasureLayer.vue - äº‹ä»¶å¤„ç†æ¡†æ¶
- âœ… MeasurePanel.vue - é¢æ¿ UI æ¨¡å¼
- âœ… useMeasureStore - çŠ¶æ€ç®¡ç†æ¨¡å¼
- âœ… TopRibbon.vue - å·¥å…·æ æ‰©å±•ç‚¹

### OpenSpec ç›¸å…³
- âœ… platform spec - éœ€è¦æ·»åŠ ç»˜åˆ¶å·¥å…·éœ€æ±‚

## Risks & Mitigation

### 1. é¡¶ç‚¹ç¼–è¾‘æ€§èƒ½é—®é¢˜
**é£é™©**ï¼šæ‹–æ‹½å¤§é‡é¡¶ç‚¹ï¼ˆ>100ï¼‰æ—¶å¯èƒ½å¡é¡¿
**ç¼“è§£**ï¼š
- ä½¿ç”¨ CallbackProperty å»¶è¿Ÿæ›´æ–°
- é™åˆ¶å•ä¸ªè¦ç´ æœ€å¤§é¡¶ç‚¹æ•°ï¼ˆå¦‚200ä¸ªï¼‰
- æä¾›ç®€åŒ–å‡ ä½•åŠŸèƒ½

### 2. æ•æ‰åŠŸèƒ½è®¡ç®—å¤æ‚åº¦
**é£é™©**ï¼šæ•æ‰è®¡ç®—åœ¨è¦ç´ å¾ˆå¤šæ—¶å¯èƒ½å½±å“äº¤äº’
**ç¼“è§£**ï¼š
- å±å¹•ç©ºé—´è®¡ç®—ï¼ˆ2D æŠ•å½±ï¼‰
- R-tree ç©ºé—´ç´¢å¼•
- å¯é…ç½®æ•æ‰è·ç¦»ï¼ˆé»˜è®¤10pxï¼‰

### 3. æ ·å¼é…ç½®å¤æ‚åº¦
**é£é™©**ï¼šCesium Material ç³»ç»Ÿä¸ 2D æ ·å¼å·®å¼‚
**ç¼“è§£**ï¼š
- é¢„è®¾å¸¸ç”¨æ ·å¼æ¨¡æ¿
- éšè—å¤æ‚é€‰é¡¹ï¼ˆä¸“å®¶æ¨¡å¼ï¼‰
- å®æ—¶é¢„è§ˆ

### 4. GeoJSON åæ ‡ç³»è½¬æ¢
**é£é™©**ï¼šCesium ä½¿ç”¨ WGS84ï¼ŒGeoJSON å¯èƒ½æœ‰å¤šç§åæ ‡ç³»
**ç¼“è§£**ï¼š
- è‡ªåŠ¨æ£€æµ‹ CRS
- æä¾›åæ ‡ç³»é€‰æ‹©å™¨
- å¯¼å…¥å‰éªŒè¯

### 5. ç”¨æˆ·å­¦ä¹ æ›²çº¿
**é£é™©**ï¼šåŠŸèƒ½è¿‡å¤šå¯èƒ½è®©ç”¨æˆ·å›°æƒ‘
**ç¼“è§£**ï¼š
- åˆ†é˜¶æ®µå‘å¸ƒï¼ˆåŸºç¡€â†’é«˜çº§ï¼‰
- å·¥å…·æç¤ºï¼ˆTooltipï¼‰
- å¿«æ·é”®æç¤º
- è§†é¢‘æ•™ç¨‹

## Success Metrics

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] æ”¯æŒ 5 ç§åŸºç¡€å‡ ä½•ç±»å‹ï¼ˆç‚¹ã€çº¿ã€é¢ã€åœ†ã€çŸ©å½¢ï¼‰
- [ ] å®ç°é€‰æ‹©ã€ç¼–è¾‘ã€æ ·å¼é…ç½®
- [ ] GeoJSON å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æ­£å¸¸

### æ€§èƒ½æŒ‡æ ‡
- [ ] ç»˜åˆ¶ 100 ä¸ªè¦ç´ æ—¶äº¤äº’æµç•…ï¼ˆ>30fpsï¼‰
- [ ] é¡¶ç‚¹ç¼–è¾‘å“åº”æ—¶é—´ < 100ms
- [ ] æ„å»ºäº§ç‰©å¢é‡ < 100KBï¼ˆgzipï¼‰

### ç”¨æˆ·ä½“éªŒ
- [ ] å·¥å…·åˆ‡æ¢å“åº”æ—¶é—´ < 200ms
- [ ] æ ·å¼ä¿®æ”¹å®æ—¶é¢„è§ˆ
- [ ] æ‰€æœ‰äº¤äº’æä¾›è§†è§‰åé¦ˆ

## Timeline Estimate

### Phase 1: åŸºç¡€ç»˜åˆ¶å·¥å…·ï¼ˆ3-4å¤©ï¼‰
- Day 1-2: ç‚¹ã€çº¿ç»˜åˆ¶å·¥å…·
- Day 2-3: åœ†ã€çŸ©å½¢ç»˜åˆ¶å·¥å…·
- Day 3-4: DrawLayer æ¶æ„ä¼˜åŒ–

### Phase 2: é€‰æ‹©ä¸ç®¡ç†ï¼ˆ2-3å¤©ï¼‰
- Day 1-2: é€‰æ‹©åŠŸèƒ½ã€é«˜äº®
- Day 2-3: FeatureListPanel

### Phase 3: ç¼–è¾‘åŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰
- Day 1-2: è¦ç´ ç§»åŠ¨
- Day 2-4: é¡¶ç‚¹ç¼–è¾‘

### Phase 4: æ ·å¼ä¸å±æ€§ï¼ˆ2-3å¤©ï¼‰
- Day 1-2: StylePanel
- Day 2-3: PropertiesPanel

### Phase 5: æ•°æ®ç®¡ç†ï¼ˆ2å¤©ï¼‰
- Day 1: GeoJSON å¯¼å‡º
- Day 2: GeoJSON å¯¼å…¥

### Phase 6: é«˜çº§åŠŸèƒ½ï¼ˆ3-4å¤©ï¼‰
- Day 1-2: æ•æ‰åŠŸèƒ½
- Day 2-4: æ’¤é”€/é‡åš

**æ€»è®¡ï¼š15-20 å¤©**

## Alternatives Considered

### 1. ä½¿ç”¨ç¬¬ä¸‰æ–¹ Cesium ç»˜åˆ¶åº“
**æ–¹æ¡ˆ**ï¼šé›†æˆ cesium-drawhelper æˆ–ç±»ä¼¼åº“
**ä¼˜ç‚¹**ï¼šå¿«é€Ÿå®ç°
**ç¼ºç‚¹**ï¼š
- æ ·å¼ä¸é¡¹ç›®ä¸ç»Ÿä¸€
- éš¾ä»¥å®šåˆ¶
- å¯èƒ½åœæ­¢ç»´æŠ¤
**å†³ç­–**ï¼šâŒ ä¸é‡‡ç”¨ï¼Œè‡ªç ”æ›´å¯æ§

### 2. ä¿æŒæµ‹é‡å·¥å…·ç‹¬ç«‹ï¼Œä¸æ‰©å±•ç»˜åˆ¶åŠŸèƒ½
**æ–¹æ¡ˆ**ï¼šåªä¿ç•™è·ç¦»ã€é¢ç§¯æµ‹é‡
**ä¼˜ç‚¹**ï¼šå®ç°ç®€å•
**ç¼ºç‚¹**ï¼š
- ä¸šåŠ¡éœ€æ±‚æ— æ³•æ»¡è¶³
- é”™è¿‡å·²æœ‰åŸºç¡€è®¾æ–½å¤ç”¨æœºä¼š
**å†³ç­–**ï¼šâŒ ä¸é‡‡ç”¨

### 3. å…ˆå®ç°å¯¼å…¥å¯¼å‡ºï¼Œå»¶è¿Ÿç»˜åˆ¶åŠŸèƒ½
**æ–¹æ¡ˆ**ï¼šå…ˆæ”¯æŒåŠ è½½å¤–éƒ¨ GeoJSON
**ä¼˜ç‚¹**ï¼šå¿«é€Ÿæ”¯æŒæ•°æ®å¯è§†åŒ–
**ç¼ºç‚¹**ï¼š
- æ— æ³•ç°åœºæ ‡æ³¨
- ç”¨æˆ·ä»éœ€å¤–éƒ¨å·¥å…·ç»˜åˆ¶
**å†³ç­–**ï¼šâŒ ä¸é‡‡ç”¨ï¼Œç»˜åˆ¶æ˜¯æ ¸å¿ƒéœ€æ±‚

## Open Questions

1. **æ˜¯å¦éœ€è¦åç«¯æŒä¹…åŒ–ï¼Ÿ**
   - å‰ç«¯ localStorage è¶³å¤Ÿï¼Ÿ
   - éœ€è¦å¤šç”¨æˆ·åä½œï¼Ÿ
   - å›ç­”ï¼šå…ˆå®ç°æœ¬åœ°ï¼Œåç»­å¯é€‰åç«¯

2. **æ ·å¼é¢„è®¾åº“çš„å†…å®¹ï¼Ÿ**
   - æ°´åˆ©è¡Œä¸šæ ‡å‡†è‰²ï¼Ÿ
   - è‡ªå®šä¹‰ vs é¢„è®¾å¹³è¡¡ï¼Ÿ
   - å›ç­”ï¼šæä¾› 5-10 ä¸ªé¢„è®¾ï¼Œæ”¯æŒè‡ªå®šä¹‰

3. **æ•æ‰å®¹å·®é»˜è®¤å€¼ï¼Ÿ**
   - 10px åœ¨ä¸åŒåˆ†è¾¨ç‡ä¸‹æ˜¯å¦åˆé€‚ï¼Ÿ
   - æ˜¯å¦éœ€è¦è‡ªé€‚åº”ï¼Ÿ
   - å›ç­”ï¼š10px é»˜è®¤ï¼Œå¯åœ¨è®¾ç½®ä¸­è°ƒæ•´

4. **è¦ç´ æ•°é‡é™åˆ¶ï¼Ÿ**
   - æ˜¯å¦éœ€è¦é™åˆ¶æœ€å¤§è¦ç´ æ•°ï¼Ÿ
   - å¦‚ä½•å¤„ç†è¶…é™æƒ…å†µï¼Ÿ
   - å›ç­”ï¼šè­¦å‘Šä½†ä¸å¼ºåˆ¶ï¼Œå»ºè®®<500ä¸ª

## References

- **å½“å‰é¡¹ç›® OpenSpec**: `openspec/changes/implement-gis-measure-tools/`
- **2D GIS å‚è€ƒé¡¹ç›®**: `GIS_OPERATIONS_GUIDE.md`
- **è¿ç§»è®¡åˆ’æ–‡æ¡£**: `docs/GIS_FEATURE_MIGRATION_PLAN.md`
- **Cesium ç»˜åˆ¶ç¤ºä¾‹**: https://sandcastle.cesium.com/?src=Drawing.html
- **GeoJSON è§„èŒƒ**: https://geojson.org/
