# 1_requirements.md - 业务需求说明书

## 1. 项目概述
本项目旨在构建一个**水利数字孪生基础平台 (Water Conservancy Digital Twin Platform)**。该平台集成了高精度 3D 地理信息（Cesium）、多物理场水利模型仿真、物联网（IoT）设备监控以及生成式 AI 辅助决策功能。

系统核心目标是服务于**指挥决策（领导）**、**专业分析（工程师）**和**运维管理（管理员）**三种角色，提供从宏观态势感知到微观数据治理的全链路能力。

---

## 2. 核心模块与功能列表

系统采用 **“1+5” 架构**，包含 1 个全域态势驾驶舱和 5 个专业业务子系统，通过底部 Dock 栏进行平滑切换。

### 2.1 全域态势感知 (Dashboard) - [首页]
*   **定位**：全局监控与指挥中心，强调“一眼看全”的高密度信息展示。
*   **核心看板**：
    *   **运行概览 (KPI)**：展示安全运行天数、当前蓄水率（%）、今日累计降雨、待办预警数。
    *   **未来趋势 (Weather)**：展示未来 3-7 天的天气图标、降雨量预测（mm）。
    *   **现场监控 (CCTV)**：接入重点区域（溢洪道、坝顶、闸门）的实时视频流，支持点击放大。
    *   **实时水情**：显示关键断面的水位/流量实时曲线及超警状态（洪峰过境提示）。
    *   **AI 智能参谋**：基于 DeepSeek-R1 的悬浮对话框，自动生成水情简报，支持自然语言问答。
*   **资源控制**：底部提供简化的图层开关（基础地理、BIM 模型、视频点位）。

### 2.2 仿真推演中心 (Simulation)
*   **定位**：工程师专用的水利模型计算工作台。
*   **视图模式**：**沉浸作业模式**（背景地图清晰，UI 位于左右侧边，支持 3D 飞入）。
*   **支持模型引擎 (Model Engines)**：
    1.  **HEC-RAS (洪水演进)**：输入流量、糙率；输出淹没面积、水深分布、流速矢量。
    2.  **MIKE Hydro (流域水动力)**：输入降雨边界；输出河网流速、汇流过程。
    3.  **HST-Stat (大坝安全回归)**：输入库水位、环境温度、时效因子；输出坝顶径向位移（mm）及变形趋势。
*   **交互要求**：
    *   **参数配置**：支持滑块/输入框实时调节，支持工况文件导入（CSV/XML）。
    *   **结果分析**：支持生成并导出分析报告（PDF），图表支持 ECharts 交互。

### 2.3 气象分析与预报 (Meteorology)
*   **定位**：雷达数据反演与降雨场校准工具。
*   **视图模式**：**全屏作业模式**（强制 **2D 正射视角**）。
*   **核心算法**：雷达反射率 (Z) 转降雨率 (R)，公式 $Z = a \cdot R^b$。用户需可调节参数 $a$ (10-500) 和 $b$ (1.0-3.0)。
*   **交互要求**：
    *   **全屏卷帘 (Split Screen)**：无 UI 遮挡，左侧显示原始雷达回波 (dBZ)，右侧显示反演降雨场 (mm)。
    *   支持中间滑块全屏拖拽对比。
    *   支持地面雨量站偏差校准开关及散点图分析。

### 2.4 数据治理中心 (Data Governance)
*   **定位**：异常数据清洗后台。
*   **视图模式**：**专注管理模式**（背景地图模糊变暗，UI 为居中模态框）。
*   **核心功能**：
    *   **QAQC 规则配置**：设置极值检测阈值、突变检测阈值。
    *   **异常数据列表**：展示被拦截的数据（时间、站点、原始值、拦截原因）。
    *   **修复策略**：支持“线性插值”和“空间插值 (IDW)”自动修复。
    *   支持清洗结果报表导出（Excel）。

### 2.5 设备运维中心 (Device Manager)
*   **定位**：IoT 硬件状态监控。
*   **视图模式**：**专注管理模式**。
*   **核心功能**：
    *   **设备拓扑**：左侧列表/树状图显示 RTU 在线状态、网络类型（4G/NB-IoT）、信号延迟。
    *   **协议日志终端**：右侧黑底终端实时滚动显示原始 HEX 报文和解析后的 JSON 数据。
    *   **协议标准**：支持 **SL651-2014** (水文规约) 和 **Modbus RTU**。

### 2.6 AI 工程中心 (AI Engineering)
*   **定位**：知识库与提示词管理。
*   **视图模式**：**专注管理模式**。
*   **核心功能**：
    *   **RAG 知识库**：支持 PDF/Word 防洪预案上传，显示向量化索引状态。
    *   **Prompt 调试**：编辑 System Prompt，在右侧 Playground 进行测试对话，验证 RAG 检索准确率。

---

## 3. 全局交互与工具系统

### 3.1 顶部导航栏 (Top Ribbon)
采用 **“倒品字形”** 布局，最大化空间利用率。
*   **左侧 (Info)**：天气状态、内存负载、系统时间。
*   **中间 (Title)**：平台名称（居中高亮），视觉锚点。
*   **右侧 (Toolbar)**：平铺展示高频工具，**零级菜单**直接触达。

### 3.2 GIS 分析工具箱
位于顶部右侧，包含以下高频工具：
*   **空间量测**：测距、测面、高度测量。
*   **地形剖面**：绘制路径生成高程剖面图。
*   **淹没分析**：
    *   **交互**：点击图标，正下方弹出悬浮面板。
    *   **功能**：非物理模型的视觉高程抬升演示。
    *   **性能**：拖动滑块时数值无重影，渲染流畅。
*   **视点管理**：保存/恢复相机视角。

### 3.3 全局控制能力
*   **显隐控制 (Toggle UI)**：一键隐藏所有侧边栏和 Dock，仅保留地图和顶部极简栏，用于纯粹的 3D 漫游演示。
*   **2D/3D 切换**：除气象模块强制 2D 外，用户可手动切换地图模式。
*   **全屏**：支持浏览器全屏显示。

---

## 4. 数据与逻辑模型

### 4.1 仿真参数模型 (TypeScript Interface)
```typescript
interface SimulationParams {
  engine: 'HEC-RAS' | 'MIKE' | 'HST-Stat'; // 新增 HST-Stat
  // 洪水模型参数
  flow?: number;      // 入库流量
  roughness?: number; // 曼宁糙率 n
  // 大坝模型参数 (新增)
  waterHeight?: number; // 库水位 (m)
  temperature?: number; // 环境温度 (°C)
  agingFactor?: number; // 时效因子
}
```

### 4.2 资源操作接口
所有业务面板需统一提供以下操作入口（右上角微型图标）：
*   `import`: 导入工况/配置 (CSV/JSON)。
*   `export`: 导出报表/结果 (PDF/Excel)。
*   `save`: 保存当前方案快照。

---

## 5. 非功能性需求
1.  **性能优先**：
    *   进入“管理模式”模糊背景时，底层 Cesium 应**暂停渲染**。
    *   快速拖动滑块时，数值显示需优化渲染机制（如 `will-change`），避免重影。
2.  **视觉统一**：严格遵守“深蓝+赛博青”的配色体系，区分“沉浸作业（清晰）”与“专注管理（模糊）”两种视觉状态。
3.  **响应式**：侧边栏高度自适应，内部内容支持滚动，适应 1080P 及以上分辨率。