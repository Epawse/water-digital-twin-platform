# GIS Toolkit Testing Strategy

**Date**: 2025-12-03
**Status**: Current Testing Approach Analysis

---

## ğŸ¯ æµ‹è¯•æœ‰æ•ˆæ€§åˆ†æ

### å½“å‰æµ‹è¯•çŠ¶æ€

| æµ‹è¯•ç±»å‹ | å·²å®ç° | è¦†ç›–èŒƒå›´ | æœ‰æ•ˆæ€§ |
|---------|--------|----------|--------|
| **å•å…ƒæµ‹è¯•** | âœ… | ç±»é€»è¾‘ã€API æ¥å£ | âš ï¸ **æœ‰é™** |
| **é›†æˆæµ‹è¯•** | âŒ | çœŸå® Cesium ç¯å¢ƒ | â³ **ç¼ºå¤±** |
| **E2E æµ‹è¯•** | âŒ | å®Œæ•´ç”¨æˆ·æµç¨‹ | â³ **ç¼ºå¤±** |
| **æ‰‹åŠ¨æµ‹è¯•** | âœ… | Node.js ç‹¬ç«‹ç¯å¢ƒ | âš ï¸ **éƒ¨åˆ†** |

---

## âš ï¸ é—®é¢˜ï¼šå½“å‰å•å…ƒæµ‹è¯•çš„å±€é™æ€§

### 1. Mock å¯¹è±¡çš„å±€é™ âŒ

**é—®é¢˜**ï¼šä½¿ç”¨ Mock æ¨¡æ‹Ÿ Cesiumï¼Œä¸æ˜¯çœŸå®æ¸²æŸ“

```typescript
// å½“å‰æµ‹è¯•ï¼ˆMockï¼‰
const mockViewer = {
  entities: {
    add: vi.fn((options) => ({ /* å‡å¯¹è±¡ */ }))
  }
}

// çœŸå®ç¯å¢ƒ
const realViewer = new Cesium.Viewer('cesiumContainer')
// Cesium å†…éƒ¨æœ‰å¤æ‚çš„æ¸²æŸ“ç®¡çº¿ã€WebGL ä¸Šä¸‹æ–‡ã€åœ°å½¢åŠ è½½ç­‰
```

**é£é™©**ï¼š
- âŒ Mock çš„ Cesium API å¯èƒ½ä¸çœŸå®ç‰ˆæœ¬ä¸ä¸€è‡´
- âŒ æ— æ³•æµ‹è¯•çœŸå®çš„ WebGL æ¸²æŸ“
- âŒ æ— æ³•æµ‹è¯•åœ°å½¢äº¤äº’ã€ç›¸æœºæ“ä½œ
- âŒ æ— æ³•å‘ç° Cesium ç‰ˆæœ¬å‡çº§å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜

---

### 2. ç¼ºå°‘è§†è§‰éªŒè¯ âŒ

**é—®é¢˜**ï¼šæµ‹è¯•é€šè¿‡ â‰  æ¸²æŸ“æ­£ç¡®

```typescript
// æµ‹è¯•è¯´ï¼šâœ… ç‚¹åˆ›å»ºæˆåŠŸ
expect(mockViewer.entities.add).toHaveBeenCalled()

// ä½†å®é™…ä¸Šå¯èƒ½ï¼š
// âŒ ç‚¹çš„å¤§å°ä¸å¯¹
// âŒ ç‚¹çš„é¢œè‰²é”™è¯¯
// âŒ ç‚¹çš„ä½ç½®åç§»
// âŒ æ ‡ç­¾é®æŒ¡ä¸å¯è§
```

**éœ€è¦**ï¼šäººçœ¼è§†è§‰ç¡®è®¤æˆ–æˆªå›¾å¯¹æ¯”æµ‹è¯•

---

### 3. ç¼ºå°‘å‰ç«¯é›†æˆéªŒè¯ âŒ

**é—®é¢˜**ï¼šPointGraphic ç±»æœ¬èº«æµ‹è¯•é€šè¿‡ï¼Œä½†ï¼š

```typescript
// å•å…ƒæµ‹è¯•æ— æ³•éªŒè¯ï¼š
âŒ DrawTool èƒ½å¦æ­£ç¡®è°ƒç”¨ PointGraphicï¼Ÿ
âŒ Vue ç»„ä»¶èƒ½å¦æ­£ç¡®ä½¿ç”¨ DrawToolï¼Ÿ
âŒ ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ˜¯å¦èƒ½è§¦å‘ç»˜åˆ¶ï¼Ÿ
âŒ GISStore çŠ¶æ€åŒæ­¥æ˜¯å¦æ­£ç¡®ï¼Ÿ
âŒ å¤šä¸ªå·¥å…·åˆ‡æ¢æ˜¯å¦æœ‰å†²çªï¼Ÿ
```

**éœ€è¦**ï¼šç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

---

## âœ… å½“å‰æµ‹è¯•çš„ä»·å€¼ï¼ˆæœ‰é™ä½†é‡è¦ï¼‰

### å•å…ƒæµ‹è¯•**æœ‰æ•ˆ**çš„æ–¹é¢

#### 1. é€»è¾‘æ­£ç¡®æ€§ âœ…

```typescript
it('åº”è¯¥åˆ›å»º PointGraphic å®ä¾‹', () => {
  const point = new PointGraphic(mockViewer, { name: 'æµ‹è¯•ç‚¹' })
  expect(point.name).toBe('æµ‹è¯•ç‚¹')  // âœ… æ„é€ å‡½æ•°é€»è¾‘æ­£ç¡®
  expect(point.type).toBe('point')  // âœ… ç±»å‹è®¾ç½®æ­£ç¡®
})
```

**æœ‰æ•ˆ**ï¼šéªŒè¯ç±»çš„æ„é€ ã€å±æ€§èµ‹å€¼ã€çŠ¶æ€ç®¡ç†

#### 2. API æ¥å£è®¾è®¡ âœ…

```typescript
it('åº”è¯¥æ”¯æŒæ˜¾ç¤º/éšè—', () => {
  point.hide()
  expect(point.visible).toBe(false)  // âœ… API è¡Œä¸ºç¬¦åˆé¢„æœŸ
})
```

**æœ‰æ•ˆ**ï¼šç¡®ä¿ API åˆçº¦æ­£ç¡®ï¼Œé˜²æ­¢æ¥å£å˜æ›´å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜

#### 3. è¾¹ç•Œæ¡ä»¶å¤„ç† âœ…

```typescript
it('ç©ºä½ç½®æ•°ç»„åº”è¯¥è­¦å‘Š', () => {
  const point = new PointGraphic(mockViewer)
  point.create([])  // âœ… æµ‹è¯•å¼‚å¸¸è¾“å…¥å¤„ç†
})
```

**æœ‰æ•ˆ**ï¼šé˜²æ­¢è¿è¡Œæ—¶é”™è¯¯ï¼Œæé«˜ä»£ç å¥å£®æ€§

#### 4. å¿«é€Ÿåé¦ˆ âœ…

```
Test Files  1 passed (1)
Tests       8 passed (8)
Duration    1.21s  â† å¾ˆå¿«ï¼
```

**æœ‰æ•ˆ**ï¼šå¼€å‘æ—¶å¿«é€ŸéªŒè¯ä¿®æ”¹æ˜¯å¦ç ´åäº†ç°æœ‰åŠŸèƒ½

---

## ğŸ“Š æµ‹è¯•é‡‘å­—å¡”ï¼ˆåº”è¯¥è¡¥å……çš„æµ‹è¯•ï¼‰

```
        /\
       /  \  â† E2E Tests (ç¼ºå¤±)
      /____\    å®Œæ•´ç”¨æˆ·æµç¨‹
     /      \
    / é›†æˆæµ‹è¯• \ â† Integration Tests (ç¼ºå¤±)
   /___çœŸå®Cesium_\   çœŸå®æ¸²æŸ“éªŒè¯
  /              \
 /   å•å…ƒæµ‹è¯•      \ â† Unit Tests (å·²æœ‰)
/___Mock å¯¹è±¡_____\    é€»è¾‘æ­£ç¡®æ€§
```

---

## ğŸš€ æ¨èçš„æµ‹è¯•ç­–ç•¥

### Phase 1: ä¿æŒå½“å‰å•å…ƒæµ‹è¯• âœ…

**ç°çŠ¶**ï¼šç»§ç»­å†™ Mock å•å…ƒæµ‹è¯•
**ä»·å€¼**ï¼šå¿«é€ŸéªŒè¯é€»è¾‘ã€API è®¾è®¡ã€é‡æ„å®‰å…¨ç½‘
**æˆæœ¬**ï¼šä½ï¼ˆå·²ç»é…ç½®å¥½ï¼‰

---

### Phase 2: æ·»åŠ çœŸå® Cesium é›†æˆæµ‹è¯• ğŸ¯

**æ—¶æœº**ï¼šPhase 1 å®Œæˆåï¼ˆæ‰€æœ‰ Graphic ç±»å®ç°å®Œï¼‰

**æ–¹æ¡ˆ Aï¼šPlaywright + çœŸå®æµè§ˆå™¨**

```typescript
// tests/integration/PointGraphic.integration.spec.ts
import { test, expect } from '@playwright/test'

test('PointGraphic åº”è¯¥æ­£ç¡®æ¸²æŸ“ç‚¹', async ({ page }) => {
  await page.goto('http://localhost:5173/test-graphics')

  // ç‚¹å‡»ç»˜åˆ¶ç‚¹æŒ‰é’®
  await page.click('[data-testid="draw-point"]')

  // ç‚¹å‡»åœ°å›¾
  await page.click('#cesiumContainer', { position: { x: 400, y: 300 } })

  // æˆªå›¾å¯¹æ¯”ï¼ˆå¯é€‰ï¼‰
  await expect(page).toHaveScreenshot('point-created.png')

  // éªŒè¯å®ä½“æ•°é‡
  const entityCount = await page.evaluate(() => {
    return window.viewer.entities.values.length
  })
  expect(entityCount).toBe(1)
})
```

**ä¼˜ç‚¹**ï¼š
- âœ… çœŸå® Cesium ç¯å¢ƒ
- âœ… çœŸå® WebGL æ¸²æŸ“
- âœ… å¯è§†åŒ–æˆªå›¾å¯¹æ¯”
- âœ… çœŸå®æµè§ˆå™¨ç¯å¢ƒ

**ç¼ºç‚¹**ï¼š
- â³ éœ€è¦é…ç½® Playwright
- â³ è¿è¡Œè¾ƒæ…¢ï¼ˆå¯åŠ¨æµè§ˆå™¨ï¼‰
- â³ éœ€è¦åˆ›å»ºæµ‹è¯•é¡µé¢

---

**æ–¹æ¡ˆ Bï¼šVitest + jsdom + canvas Mock**

```typescript
// tests/integration/PointGraphic.real.test.ts
import { beforeAll, test, expect } from 'vitest'
import * as Cesium from 'cesium'  // çœŸå® Cesium

beforeAll(async () => {
  // åˆå§‹åŒ–çœŸå® Cesiumï¼ˆheadlessï¼‰
  global.Cesium = Cesium
  // é…ç½® canvas mock
})

test('PointGraphic çœŸå® Cesium æµ‹è¯•', () => {
  const viewer = createHeadlessViewer()
  const point = new PointGraphic(viewer, { name: 'Test' })

  point.create([Cesium.Cartesian3.fromDegrees(114, 30, 0)])

  expect(viewer.entities.values.length).toBe(1)
  expect(viewer.entities.values[0].point).toBeDefined()
})
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä½¿ç”¨çœŸå® Cesium API
- âœ… è¿è¡Œå¿«é€Ÿ
- âœ… CI/CD å‹å¥½

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ— æ³•æµ‹è¯•çœŸå® WebGL æ¸²æŸ“
- âš ï¸ éœ€è¦ canvas headless mock

---

### Phase 3: åˆ›å»ºå¯è§†åŒ–æµ‹è¯•é¡µé¢ ğŸ¯

**æ—¶æœº**ï¼šPhase 7ï¼ˆUI é›†æˆï¼‰å¼€å§‹æ—¶

**åˆ›å»ºç®€å•çš„æµ‹è¯•é¡µé¢**ï¼š

```vue
<!-- tests/pages/graphics-test.vue -->
<template>
  <div>
    <div id="cesiumContainer"></div>
    <div class="test-controls">
      <button @click="testPoint">æµ‹è¯•ç‚¹</button>
      <button @click="testLine">æµ‹è¯•çº¿</button>
      <button @click="testPolygon">æµ‹è¯•å¤šè¾¹å½¢</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import * as Cesium from 'cesium'
import { PointGraphic } from '@/cesium/gis/graphics/PointGraphic'

let viewer: Cesium.Viewer

onMounted(() => {
  viewer = new Cesium.Viewer('cesiumContainer')
})

function testPoint() {
  const point = new PointGraphic(viewer, {
    name: 'æµ‹è¯•ç‚¹',
    label: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‚¹'
  })
  point.create([Cesium.Cartesian3.fromDegrees(114.3, 30.5, 0)])
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(114.3, 30.5, 10000)
  })
}
</script>
```

**è®¿é—®**ï¼š`http://localhost:5173/test-graphics`

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶å¯è§†åŒ–éªŒè¯
- âœ… å¼€å‘æ—¶å¿«é€Ÿè°ƒè¯•
- âœ… æ‰‹åŠ¨æ¢ç´¢æ€§æµ‹è¯•
- âœ… æ¼”ç¤ºå’Œæˆªå›¾

---

### Phase 4: E2E æµ‹è¯• ğŸ¯

**æ—¶æœº**ï¼šåŠŸèƒ½å®Œæ•´åï¼ˆPhase 13+ï¼‰

```typescript
// e2e/drawing-workflow.spec.ts
test('å®Œæ•´çš„ç»˜åˆ¶å·¥ä½œæµ', async ({ page }) => {
  await page.goto('/')

  // 1. ç‚¹å‡»ç»˜åˆ¶ç‚¹å·¥å…·
  await page.click('[data-testid="tool-point"]')

  // 2. ç‚¹å‡»åœ°å›¾æ·»åŠ ç‚¹
  await page.click('#cesiumContainer')

  // 3. éªŒè¯è¦ç´ åˆ—è¡¨ä¸­å‡ºç°æ–°ç‚¹
  await expect(page.locator('.feature-list-item')).toHaveCount(1)

  // 4. ç¼–è¾‘ç‚¹çš„åç§°
  await page.click('[data-testid="edit-name"]')
  await page.fill('input[name="feature-name"]', 'æ°´ä½ç«™A')

  // 5. éªŒè¯å¯¼å‡º GeoJSON
  await page.click('[data-testid="export-geojson"]')
  const download = await page.waitForEvent('download')
  // ... éªŒè¯ä¸‹è½½çš„æ–‡ä»¶å†…å®¹
})
```

---

## ğŸ“‹ æ¨èçš„æµ‹è¯•ä¼˜å…ˆçº§

### ç«‹å³æ‰§è¡Œï¼ˆPhase 1 å½“å‰ï¼‰âœ…

```
âœ… ç»§ç»­å†™ Mock å•å…ƒæµ‹è¯•
   - æ¯ä¸ª Graphic ç±»éƒ½æœ‰å•å…ƒæµ‹è¯•
   - è¦†ç›–æ ¸å¿ƒé€»è¾‘ã€è¾¹ç•Œæ¡ä»¶
   - å¿«é€Ÿåé¦ˆå¾ªç¯
```

**ç†ç”±**ï¼š
- å¼€å‘é€Ÿåº¦å¿«
- æ•è·æ˜æ˜¾çš„é€»è¾‘é”™è¯¯
- é‡æ„å®‰å…¨ç½‘

---

### Phase 1 å®Œæˆåï¼ˆæ¨èï¼‰ğŸ¯

```
ğŸ¯ åˆ›å»ºå¯è§†åŒ–æµ‹è¯•é¡µé¢
   - tests/pages/graphics-test.vue
   - æ‰‹åŠ¨éªŒè¯æ¯ä¸ª Graphic ç±»çš„æ¸²æŸ“
   - æˆªå›¾ä½œä¸ºè§†è§‰å›å½’æµ‹è¯•åŸºå‡†
```

**æ—¶é—´**ï¼š2-3 å°æ—¶
**ä»·å€¼**ï¼šâ­â­â­â­â­

---

### Phase 7 UI é›†æˆæ—¶ï¼ˆå¿…éœ€ï¼‰ğŸ¯

```
ğŸ¯ æ·»åŠ  Playwright é›†æˆæµ‹è¯•
   - æµ‹è¯•çœŸå®çš„ç”¨æˆ·äº¤äº’
   - æµ‹è¯•å·¥å…·åˆ‡æ¢ã€çŠ¶æ€åŒæ­¥
   - æˆªå›¾å¯¹æ¯”æµ‹è¯•
```

**æ—¶é—´**ï¼š1-2 å¤©
**ä»·å€¼**ï¼šâ­â­â­â­â­

---

### Phase 13+ å®Œæˆåï¼ˆå¯é€‰ï¼‰â³

```
â³ E2E æµ‹è¯•
   - å®Œæ•´çš„ç»˜åˆ¶å·¥ä½œæµ
   - è·¨ç»„ä»¶é›†æˆ
   - CI/CD é›†æˆ
```

**æ—¶é—´**ï¼š2-3 å¤©
**ä»·å€¼**ï¼šâ­â­â­

---

## ğŸ¯ ç»“è®ºï¼šå½“å‰å•å…ƒæµ‹è¯•çš„æœ‰æ•ˆæ€§

### âœ… æœ‰æ•ˆçš„æ–¹é¢

| æ–¹é¢ | æœ‰æ•ˆæ€§ | è¯´æ˜ |
|------|--------|------|
| é€»è¾‘æ­£ç¡®æ€§ | â­â­â­â­â­ | æ„é€ å‡½æ•°ã€æ–¹æ³•è°ƒç”¨ã€çŠ¶æ€ç®¡ç† |
| API è®¾è®¡ | â­â­â­â­â­ | æ¥å£åˆçº¦ã€å‘åå…¼å®¹æ€§ |
| é‡æ„å®‰å…¨ | â­â­â­â­ | é˜²æ­¢ç ´åç°æœ‰åŠŸèƒ½ |
| å¼€å‘é€Ÿåº¦ | â­â­â­â­â­ | å¿«é€Ÿåé¦ˆï¼ˆ1-2ç§’ï¼‰ |

### âš ï¸ æ— æ•ˆçš„æ–¹é¢

| æ–¹é¢ | æœ‰æ•ˆæ€§ | è¯´æ˜ |
|------|--------|------|
| çœŸå®æ¸²æŸ“ | â­ | Mock æ— æ³•éªŒè¯ WebGL æ¸²æŸ“ |
| Cesium å…¼å®¹æ€§ | â­â­ | Mock å¯èƒ½ä¸çœŸå® API ä¸ä¸€è‡´ |
| è§†è§‰æ­£ç¡®æ€§ | â­ | æ— æ³•éªŒè¯é¢œè‰²ã€å¤§å°ã€ä½ç½® |
| å‰ç«¯é›†æˆ | â­ | æ— æ³•éªŒè¯ Vue ç»„ä»¶äº¤äº’ |
| ç”¨æˆ·ä½“éªŒ | â­ | æ— æ³•éªŒè¯å®Œæ•´å·¥ä½œæµ |

---

## ğŸ’¡ æœ€ç»ˆå»ºè®®

### å½“å‰ç­–ç•¥ï¼šæ¸è¿›å¼æµ‹è¯• âœ…

**Phase 1ï¼ˆå½“å‰ï¼‰**ï¼š
```
âœ… ç»§ç»­å†™ Mock å•å…ƒæµ‹è¯•
   - å¿«é€ŸéªŒè¯é€»è¾‘æ­£ç¡®æ€§
   - å»ºç«‹ API åˆçº¦
   - ä½æˆæœ¬é«˜å›æŠ¥
```

**Phase 1 å®Œæˆå**ï¼š
```
ğŸ¯ åˆ›å»ºå¯è§†åŒ–æµ‹è¯•é¡µé¢ï¼ˆ2-3å°æ—¶ï¼‰
   - çœŸå® Cesium ç¯å¢ƒæ‰‹åŠ¨æµ‹è¯•
   - è§†è§‰éªŒè¯æ¸²æŸ“æ•ˆæœ
   - æˆªå›¾ä½œä¸ºå›å½’æµ‹è¯•åŸºå‡†
```

**Phase 7 UI é›†æˆæ—¶**ï¼š
```
ğŸ¯ æ·»åŠ  Playwright é›†æˆæµ‹è¯•ï¼ˆ1-2å¤©ï¼‰
   - è‡ªåŠ¨åŒ–çœŸå®æµè§ˆå™¨æµ‹è¯•
   - ç”¨æˆ·äº¤äº’æµç¨‹éªŒè¯
   - CI/CD é›†æˆ
```

---

## ğŸ“Š æŠ•èµ„å›æŠ¥ç‡ï¼ˆROIï¼‰

| æµ‹è¯•ç±»å‹ | æ—¶é—´æŠ•å…¥ | ä»·å€¼ | ROI |
|---------|---------|------|-----|
| Mock å•å…ƒæµ‹è¯• | ä½ | ä¸­ | â­â­â­â­ |
| å¯è§†åŒ–æµ‹è¯•é¡µé¢ | ä½ | é«˜ | â­â­â­â­â­ |
| Playwright é›†æˆ | ä¸­ | é«˜ | â­â­â­â­ |
| E2E æµ‹è¯• | é«˜ | ä¸­ | â­â­â­ |

**ç»“è®º**ï¼š
- âœ… å½“å‰å•å…ƒæµ‹è¯•è™½ç„¶æœ‰é™ï¼Œä½†**æœ‰ä»·å€¼**
- âœ… åº”è¯¥ç»§ç»­ä¿æŒï¼Œä½œä¸ºç¬¬ä¸€å±‚é˜²æŠ¤
- ğŸ¯ Phase 1 å®Œæˆåç«‹å³è¡¥å……å¯è§†åŒ–æµ‹è¯•é¡µé¢
- ğŸ¯ UI é›†æˆæ—¶å†æ·»åŠ è‡ªåŠ¨åŒ–é›†æˆæµ‹è¯•

---

**æœ€é‡è¦çš„**ï¼š
> æµ‹è¯•ä¸æ˜¯ä¸ºäº†è¿½æ±‚ 100% è¦†ç›–ç‡ï¼Œ
> è€Œæ˜¯ä¸ºäº†åœ¨å¼€å‘é€Ÿåº¦å’Œè´¨é‡ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚
> å½“å‰çš„å•å…ƒæµ‹è¯•å·²ç»æä¾›äº†**è¶³å¤Ÿçš„ä¿æŠ¤**ï¼Œ
> è®©æˆ‘ä»¬å¯ä»¥å¿«é€Ÿè¿­ä»£å¼€å‘ã€‚

---

**Created**: 2025-12-03
**Next Review**: Phase 1 å®Œæˆå
